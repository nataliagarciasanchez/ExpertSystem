package rules.treatment

import domain.Symptom;
import domain.SymptomType;
import engine.Scorecard;
import domain.Domain;

global Scorecard score;
dialect "java"

// ------------ GENERAL TREATMENT------------------------
rule "General treatment: hydroxychloroquine"
    salience 100
when
    eval(score.isEntryEligible() && score.total() >= 10)
then
    score.addTreatment(
        "Baseline therapy (all SLE patients): Hydroxychloroquine (HCQ) 200–400 mg/day unless contraindicated. " +
        "Recommended dose ≤5 mg/kg/day. HCQ reduces flares and improves long-term survival. " +
        "Baseline and annual ophthalmologic monitoring is required."
    );
end


rule "General treatment: glucocorticoid"
    salience 95
when
    eval(score.isEntryEligible() && score.total() >= 10)
then
    score.addTreatment(
        "Glucocorticoid strategy: use the lowest effective dose for the shortest possible duration. " +
        "Glucocorticoids should be used only as short-term bridging therapy. " +
        "Target maintenance prednisone ≤5–7.5 mg/day, with progressive tapering and withdrawal whenever feasible."
    );
end


// ------------RENAL DOMAIN---------------------------------
rule "Renal treatment: active lupus nephritis class III/IV or V"
    salience 85
when
    eval(score.total() >= 10 && score.getPointsForDomain(Domain.RENAL) >= 8)
then
    score.addTreatment(
        "Renal involvement (active lupus nephritis): " +
        "Induction therapy with mycophenolate mofetil (preferred) or cyclophosphamide. " +
        "High-dose intravenous corticosteroid pulses may be required for severe flares. " +
        "After induction, switch to maintenance therapy with mycophenolate or azathioprine."
    );
end

// ------------ CUTANEOUS DOMAIN ----------------------------
rule "Cutaneous treatment: acute or discoid lupus"
    salience 80
when
    eval(score.total() >= 10 && score.getPointsForDomain(Domain.MUCUTANEOUS) >= 4)
then
    score.addTreatment(
        "Cutaneous lupus involvement: strict photoprotection (SPF ≥50) is mandatory. " +
        "Use topical corticosteroids or calcineurin inhibitors for localized disease. " +
        "If cutaneous activity persists despite HCQ, consider systemic steroid-sparing agents such as methotrexate."
    );
end

// --------------NEUROPSYCHIATRIC DOMAIN-------------------------------
rule "Neuropsychiatric treatment"
    salience 75
when
    eval(score.total() >= 10 && score.getPointsForDomain(Domain.NEUROPSYCHIATRIC) >= 3)
then
    score.addTreatment(
        "Neuropsychiatric SLE (e.g. seizures, psychosis): " +
        "High-dose intravenous corticosteroids followed by oral taper are recommended. " +
        "Add cyclophosphamide for severe inflammatory neuropsychiatric disease. " +
        "Rituximab may be considered in refractory cases. " +
        "Always combine with appropriate symptomatic treatment and management of contributing factors."
    );
end

// --------------MUSCULOSKELETAL DOMAIN-----------------------------
rule "Musculoskeletal treatment: arthritis or myalgia"
    salience 70
when
    eval(score.total() >= 10 && score.getPointsForDomain(Domain.MUSCULOSKELETAL) >= 6)
then
    score.addTreatment(
        "Musculoskeletal involvement (arthritis): " +
        "NSAIDs may be used for mild symptoms if no renal or cardiovascular contraindications exist. " +
        "For persistent activity, use low-dose prednisone (≤7.5 mg/day). " +
        "Methotrexate is the preferred steroid-sparing agent; alternatives include leflunomide or azathioprine."
    );
end

// --------------HEMATOLOGIC DOMAIN---------------------------------
rule "Hematologic treatment"
    salience 65
when
    eval(score.total() >= 10 && score.getPointsForDomain(Domain.HEMATOLOGIC) >= 3)
then
    score.addTreatment(
        "Hematologic manifestations: treatment depends on severity. " +
        "Mild leukopenia may not require immunosuppression. " +
        "Moderate–severe cytopenias require oral or intravenous corticosteroids. " +
        "In refractory thrombocytopenia or hemolytic anemia, consider intravenous immunoglobulins or rituximab."
    );
end

// --------SEROSAL DOMAIN------------------------------
rule "Serosal treatment"
    salience 60
when
    eval(score.total() >= 10 && score.getPointsForDomain(Domain.SEROSAL) >= 5)
then
    score.addTreatment(
        "Serosal involvement (pleuritis or pericarditis): " +
        "NSAIDs are first-line therapy for mild disease. " +
        "If response is inadequate, add low-to-moderate dose prednisone. " +
        "Colchicine is recommended for recurrent pericarditis. " +
        "Hydroxychloroquine should be maintained whenever possible."
    );

end

// ------------IMMUNOLOGICAL DOMAIN---------------------------------
rule "Immunologic treatment: antibodies and complement"
    salience 55
when
    eval(
            score.total() >= 10 &&
            ( score.getPointsForDomain(Domain.SLE_SPECIFIC_ABS) >= 6 ||
              score.getPointsForDomain(Domain.APL) >= 2 ||
              score.getPointsForDomain(Domain.COMPLEMENT) >= 3 )
    )
then
    score.addTreatment(
        "Significant immunologic activity: continue hydroxychloroquine and consider steroid-sparing immunosuppressive therapy " +
        "(azathioprine, mycophenolate or methotrexate) according to organ involvement. " +
        "In patients with high-risk antiphospholipid antibodies without thrombosis, low-dose aspirin may be considered."
    );
end