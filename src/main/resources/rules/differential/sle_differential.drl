package rules.differential
dialect "java"

import domain.Symptom
import domain.SymptomType
import engine.Scorecard

global Scorecard score;

rule "DDX: Rheumatoid arthritis"
    salience 100
when
    eval(score.isEntryEligible() && score.total() < 10)
    and Symptom(type == SymptomType.ARTHRITIS, present == true)
    and not Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true)
then
    score.addDifferential(
        "Inflammatory arthritis in a subthreshold case without lupus-specific antibodies: consider Rheumatoid Arthritis."
    );
end

rule "DDX: Drug-induced lupus"
    salience 90
when
    eval(score.isEntryEligible() && score.total() < 10)
    and ( Symptom(type == SymptomType.DRUG_EXPOSURE_DIL, present == true)
       or Symptom(type == SymptomType.ANTI_HISTONE, present == true) )
    and not ( Symptom(type == SymptomType.NEPHRITIS_CLASS_III_IV, present == true)
           or Symptom(type == SymptomType.NEPHRITIS_CLASS_V, present == true)
           or Symptom(type == SymptomType.PSYCHOSIS, present == true)
           or Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true) )
then
    score.addDifferential(
        "Drug exposure and/or anti-histone antibodies without major organ involvement: consider Drug-induced Lupus."
    );
end

rule "DDX: Viral infection mimicking SLE"
    salience 80
when
    eval(score.isEntryEligible() && score.total() < 10)
    and ( Symptom(type == SymptomType.FEVER, present == true)
       or Symptom(type == SymptomType.LEUKOPENIA, present == true)
       or Symptom(type == SymptomType.THROMBOCYTOPENIA, present == true) )
    and not Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true)
then
    score.addDifferential(
        "Acute febrile or cytopenic lupus-like presentation without lupus-specific antibodies: consider viral infection (e.g., parvovirus B19, EBV/CMV, hepatitis viruses)."
    );
end

rule "DDX: Adult-onset Still disease"
    salience 70
when
    eval(score.isEntryEligible() && score.total() < 10)
    and Symptom(type == SymptomType.FEVER, present == true)
    and Symptom(type == SymptomType.ARTHRITIS, present == true)
    and not Symptom(type == SymptomType.ACUTE_RASH, present == true)
    and not Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true)
then
    score.addDifferential(
        "Fever and arthritis without lupus-specific autoantibodies: consider Adult-onset Still disease."
    );
end

rule "DDX: Behcet disease"
    salience 60
when
    eval(score.isEntryEligible() && score.total() < 10)
    and Symptom(type == SymptomType.ORAL_ULCERS, present == true)
    and Symptom(type == SymptomType.ARTHRITIS, present == true)
    and not Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true)
then
    score.addDifferential(
        "Oral ulcers with arthralgia/arthritis in a lupus-like presentation: consider BehÃ§et disease."
    );
end

rule "DDX: Sarcoidosis"
    salience 50
when
    eval(score.isEntryEligible() && score.total() < 10)
    and ( Symptom(type == SymptomType.FEVER, present == true)
       or Symptom(type == SymptomType.FATIGUE, present == true) )
    and not Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true)
then
    score.addDifferential(
        "Systemic symptoms without lupus-specific autoantibodies: consider Sarcoidosis."
    );
end

rule "DDX: Systemic sclerosis"
    salience 40
when
    eval(score.isEntryEligible() && score.total() < 10)
    and Symptom(type == SymptomType.RAYNAUD, present == true)
    and Symptom(type == SymptomType.SKIN_THICKENING, present == true)
then
    score.addDifferential(
        "Raynaud phenomenon with skin thickening: consider Systemic Sclerosis."
    );
end

rule "DDX: Mixed connective tissue disease"
    salience 30
when
    eval(score.isEntryEligible() && score.total() < 10)
    and Symptom(type == SymptomType.RAYNAUD, present == true)
    and Symptom(type == SymptomType.ANTI_U1RNP, present == true)
    and not Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true)
then
    score.addDifferential(
        "Raynaud phenomenon with anti-U1RNP positivity: consider Mixed Connective Tissue Disease."
    );
end

rule "DDX: Thyroid disease"
    salience 20
when
    eval(score.isEntryEligible() && score.total() < 10)
    and Symptom(type == SymptomType.FATIGUE, present == true)
    and not Symptom(type == SymptomType.ANTI_DSDNA_OR_ANTI_SM, present == true)
then
    score.addDifferential(
        "Fatigue in an ANA-positive subthreshold case: consider Thyroid disease."
    );
end
rule "DDX: Other conditions require external diagnostic testing"
salience -10
when
    eval(score.isEntryEligible() && score.total() < 10)
then
    score.addDifferential(
        "Other differential diagnoses described in clinical guidelines (e.g., endocarditis, HIV infection, Lyme disease, inflammatory bowel disease) require additional diagnostic testing not modeled in this system."
    );
end

rule "DDX guard: register subthreshold case"
    salience 1
when
    eval(score.isEntryEligible() && score.total() < 10)
then
    // Marker rule for traceability
end
